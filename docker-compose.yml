services:
  postgres:
    image: postgres:16-alpine
    container_name: canopy-indexer-postgres
    environment:
      POSTGRES_DB: canopy-indexer
      POSTGRES_USER: canopy-indexer
      POSTGRES_PASSWORD: canopy-indexer123
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"  # Use 5434 to avoid conflict with other postgres instances
    volumes:
      - canopy-indexer_postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "log_min_duration_statement=100"    # Log queries > 100ms
      - "-c"
      - "log_statement=none"                 # Don't log all statements
      - "-c"
      - "log_line_prefix=%t [%p] %u@%d "    # Timestamp, PID, user@db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U canopy-indexer -d canopy-indexer"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - canopy-indexer-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: canopy-indexer-redis
    command: redis-server --requirepass canopy-redis-dev
    ports:
      - "6381:6379"  # Use 6381 to avoid conflict with other redis instances
    volumes:
      - canopy-indexer_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "canopy-redis-dev", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - canopy-indexer-network
    restart: unless-stopped

  indexer:
    image: alpine:3.19
    container_name: canopy-indexer-indexer
    env_file: .env
    environment:
      POSTGRES_URL: "postgres://canopy-indexer:canopy-indexer123@postgres:5432/canopy-indexer?sslmode=disable"
      REDIS_URL: "redis://:canopy-redis-dev@redis:6379/0"
      ADMIN_POSTGRES_URL: "postgres://canopy-indexer:canopy-indexer123@postgres:5432/admin?sslmode=disable"
      HTTP_ENABLED: "true"
      HTTP_ADDR: ":8080"
      ADMIN_TOKEN: "devtoken"
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./bin/indexer-linux:/app/bin/indexer:ro
    working_dir: /app
    command: ["/app/bin/indexer"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rpc-mock:
        condition: service_healthy
    networks:
      - canopy-indexer-network
    restart: unless-stopped
    tty: true

  backfill:
    image: alpine:3.19
    container_name: canopy-indexer-backfill
    env_file: .env
    environment:
      POSTGRES_URL: "postgres://canopy-indexer:canopy-indexer123@postgres:5432/canopy-indexer?sslmode=disable"
      REDIS_URL: "redis://:canopy-redis-dev@redis:6379/0"
    volumes:
      - ./bin/backfill-linux:/app/bin/backfill:ro
    working_dir: /app
    command: ["/app/bin/backfill", "-chain", "1000", "-concurrency", "10", "-batch", "100", "-end", "1000"]
    depends_on:
      postgres:
        condition: service_healthy
      rpc-mock:
        condition: service_healthy
    networks:
      - canopy-indexer-network
    restart: "no"  # Run once and exit

  rpc-mock:
    build:
      context: ../canopy-rpc-mock
      dockerfile: Dockerfile
    container_name: canopy-indexer-rpc-mock
    command: ["-chains", "100", "-blocks", "100", "-start-port", "61000", "-start-chain-id", "1000"]
    ports:
      - "61000-61099:61000-61099"
    networks:
      - canopy-indexer-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:61000/v1/query/height"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

networks:
  canopy-indexer-network:
    name: canopy-indexer-network
    driver: bridge

volumes:
  canopy-indexer_postgres_data:
  canopy-indexer_redis_data:
